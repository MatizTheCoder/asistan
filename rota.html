<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Rota Oluştur</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode: 'class' };
  </script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 p-4 font-sans">

  <div class="max-w-xl mx-auto space-y-4">
    <h1 class="text-xl font-bold mb-2">Rota Oluşturucu</h1>

    <form id="route-form" class="space-y-3">
      <input id="start" type="text" placeholder="Başlangıç (örn. Ankara)" class="w-full p-2 rounded border dark:bg-gray-800 dark:text-white" required>
      <input id="end" type="text" placeholder="Varış (örn. İzmir)" class="w-full p-2 rounded border dark:bg-gray-800 dark:text-white" required>
      <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Rota Oluştur</button>
    </form>

    <div id="info" class="text-sm mt-4"></div>
    <div id="map" class="h-96 rounded-lg shadow"></div>
    <div id="weather-data" class="mt-4 space-y-2 text-sm"></div>
  </div>

<script>
const form = document.getElementById("route-form");
const info = document.getElementById("info");
const map = L.map("map").setView([39.92, 32.85], 6);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

form.addEventListener("submit", async (e) => {
  e.preventDefault();

  const startCity = document.getElementById("start").value.trim();
  const endCity = document.getElementById("end").value.trim();

  info.innerText = "Rota alınıyor...";
  map.eachLayer((layer) => {
    if (layer instanceof L.Polyline || layer instanceof L.Marker) map.removeLayer(layer);
  });

  // 🧭 Şehir isimlerini koordinata dönüştür
  const coords = await Promise.all([
    fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(startCity)}&format=json`).then(r => r.json()),
    fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(endCity)}&format=json`).then(r => r.json())
  ]);

  if (!coords[0][0] || !coords[1][0]) {
    info.innerText = "Şehirler bulunamadı.";
    return;
  }

  const start = [parseFloat(coords[0][0].lat), parseFloat(coords[0][0].lon)];
  const end = [parseFloat(coords[1][0].lat), parseFloat(coords[1][0].lon)];

  // 📡 Rota API
  const orsUrl = `https://api.openrouteservice.org/v2/directions/driving-car?api_key=YOUR_API_KEY`;
  const res = await fetch(orsUrl, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ coordinates: [[start[1], start[0]], [end[1], end[0]]] })
  });
  const data = await res.json();

  const route = data.features[0].geometry.coordinates.map(coord => [coord[1], coord[0]]);
  const distanceKm = (data.features[0].properties.summary.distance / 1000).toFixed(1);
  const durationMin = (data.features[0].properties.summary.duration / 60).toFixed(0);

  L.polyline(route, { color: "blue" }).addTo(map);
  map.fitBounds(route);

  info.innerHTML = `<strong>Mesafe:</strong> ${distanceKm} km<br><strong>Süre:</strong> ${durationMin} dakika`;

  // 🧊 Her 50km'de bir nokta al
  const line = turf.lineString(data.features[0].geometry.coordinates);
  const segments = Math.floor(distanceKm / 50);
  const intervalPoints = [];

  for (let i = 0; i <= segments; i++) {
    const pt = turf.along(line, i * 50, { units: "kilometers" });
    intervalPoints.push([pt.geometry.coordinates[1], pt.geometry.coordinates[0]]);
  }

  // ☁️ Hava durumu verileri
  const weatherContainer = document.getElementById("weather-data");
  weatherContainer.innerHTML = "";

  for (const [index, [lat, lon]] of intervalPoints.entries()) {
    const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`);
    const weather = await res.json();
    const temp = weather.current_weather.temperature;
    const wind = weather.current_weather.windspeed;

    L.marker([lat, lon]).addTo(map).bindPopup(`${temp}°C, Rüzgar: ${wind} km/h`);

    weatherContainer.innerHTML += `<p><strong>📍 Nokta ${index + 1}</strong>: ${lat.toFixed(2)}, ${lon.toFixed(2)} → 🌡️ ${temp}°C, 💨 ${wind} km/h</p>`;
  }
});
</script>

</body>
</html>
