<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Rota ve Hava Durumu</title>

  <!-- Tema (dark mode) -->
  <script>
    (function () {
      const theme = localStorage.getItem("theme");
      if (theme === "dark") {
        document.documentElement.classList.add("dark");
      }
    })();
  </script>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
    };
  </script>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <link rel="icon" href="icons/icon-192.png">
</head>
<body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 font-sans">
<main class="max-w-md mx-auto p-4 space-y-6">

  <div class="text-center">
    <h1 class="text-2xl font-bold mb-4">Rota Oluştur ve Hava Durumunu Gör</h1>
  </div>

  <form id="route-form" class="space-y-4">
    <input type="text" id="from" placeholder="Kalkış Şehri (örn. Ankara)" required class="w-full p-2 rounded border dark:bg-gray-800" />
    <input type="text" id="to" placeholder="Varış Şehri (örn. İstanbul)" required class="w-full p-2 rounded border dark:bg-gray-800" />
    <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">
      Rota Oluştur
    </button>
  </form>

  <div id="route-summary" class="bg-yellow-100 dark:bg-gray-800 rounded p-4 shadow text-sm space-y-2 hidden">
    <p><strong>Toplam Mesafe:</strong> <span id="total-distance"></span></p>
    <p><strong>Toplam Süre:</strong> <span id="total-duration"></span></p>
  </div>

  <div id="weather-container" class="space-y-4 mt-6"></div>

  <div class="text-center text-sm text-gray-500 mt-6">
    <i class="fas fa-cloud-sun mr-1"></i>Veriler OpenRouteService ve Open-Meteo API'lerinden alınmaktadır.
  </div>
</main>

<script>
  const apiKey = '5b3ce3597851110001cf6248665476b4a7b84498b22150fa85d1f538'; 

  document.getElementById("route-form").addEventListener("submit", async function (e) {
    e.preventDefault();
    const from = document.getElementById("from").value;
    const to = document.getElementById("to").value;

    try {
      const fromCoords = await getCoordinates(from);
      const toCoords = await getCoordinates(to);
      const route = await getRoute(fromCoords, toCoords);

      const distance = route.features[0].properties.summary.distance;
      const duration = route.features[0].properties.summary.duration;

      showSummary(distance, duration, from, to);
      await extractWeatherPointsAndShow(route, distance);
    } catch (err) {
      alert("Rota alınamadı: " + err.message);
    }
  });

  async function getCoordinates(place) {
    const res = await fetch(`https://api.openrouteservice.org/geocode/search?api_key=${apiKey}&text=${place}`);
    const data = await res.json();
    const coords = data.features[0].geometry.coordinates;
    return coords;
  }

  async function getRoute(fromCoords, toCoords) {
    const body = {
      coordinates: [fromCoords, toCoords],
      instructions: false,
      geometry: true
    };
    const res = await fetch("https://api.openrouteservice.org/v2/directions/driving-car/geojson", {
      method: "POST",
      headers: {
        "Authorization": apiKey,
        "Content-Type": "application/json"
      },
      body: JSON.stringify(body)
    });
    return await res.json();
  }

  function showSummary(distanceMeters, durationSeconds, fromCity, toCity) {
    const km = (distanceMeters / 1000).toFixed(1);
    const hours = Math.floor(durationSeconds / 3600);
    const minutes = Math.round((durationSeconds % 3600) / 60);

    document.getElementById("total-distance").innerText = `${fromCity} → ${toCity} arası ${km} km`;
    document.getElementById("total-duration").innerText = `${hours} saat ${minutes} dakika`;

    document.getElementById("route-summary").classList.remove("hidden");
  }

  async function extractWeatherPointsAndShow(route, distanceMeters, durationSeconds) {
    const stepCount = Math.floor(distanceMeters / 50000);
    const coords = route.features[0].geometry.coordinates;
    const totalPoints = coords.length;
    const gap = Math.floor(totalPoints / stepCount);
    const weatherContainer = document.getElementById("weather-container");
    weatherContainer.innerHTML = "";
  
    const startTime = new Date(); // Kullanıcının rotayı oluşturduğu an
  
    for (let i = 0; i <= stepCount; i++) {
      const point = coords[i * gap];
      if (!point) continue;
  
      const lon = point[0];
      const lat = point[1];
  
      // Her adım için tahmini süre
      const progressRatio = i / stepCount;
      const eta = new Date(startTime.getTime() + durationSeconds * 1000 * progressRatio);
      const etaHour = eta.getHours();
      const formattedTime = eta.toLocaleTimeString("tr-TR", { hour: "2-digit", minute: "2-digit" });
  
      // Hava verisini alın (tahmini saatteki hava durumu)
      const weather = await getWeatherAt(lat, lon, etaHour);
      const locationName = await getLocationName(lat, lon);
  
      if (weather) {
        weatherContainer.innerHTML += `
          <div class="p-4 bg-blue-100 dark:bg-blue-900 rounded-lg shadow">
            <p><i class="fas fa-location-dot mr-1"></i><strong>Konum:</strong> ${locationName}</p>
            <p><strong>Sıcaklık:</strong> ${weather.temperature}°C</p>
            <p><strong>Durum:</strong> ${weatherCodeToText(weather.weathercode)}</p>
            <p><strong>Tahmini Saat:</strong> ${formattedTime}</p>
            <div class="text-2xl mt-2">${weatherCodeToIcon(weather.weathercode)}</div>
          </div>
        `;
      }
    }
  }


  async function getLocationName(lat, lon) {
  try {
    const res = await fetch(`https://api.openrouteservice.org/geocode/reverse?api_key=${apiKey}&point.lat=${lat}&point.lon=${lon}&size=1`);
    const data = await res.json();
    const address = data.features[0].properties;
    return `${address.locality || address.county || address.region || 'Bilinmeyen Konum'}`;
  } catch (err) {
    console.error("Konum adı alınamadı:", err);
    return `${lat.toFixed(2)}, ${lon.toFixed(2)}`;
  }
}



async function getWeatherAt(lat, lon, hour) {
  try {
    const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,weathercode&timezone=auto`);
    const data = await res.json();

    // Hedef saati bul
    const index = data.hourly.time.findIndex(t => new Date(t).getHours() === hour);
    if (index === -1) return null;

    return {
      temperature: data.hourly.temperature_2m[index],
      weathercode: data.hourly.weathercode[index]
    };
  } catch (err) {
    console.error("Hava durumu alınamadı:", err);
    return null;
  }
}


  function weatherCodeToText(code) {
    const map = {
      0: "Güneşli", 1: "Az Bulutlu", 2: "Parçalı Bulutlu", 3: "Kapalı",
      45: "Sisli", 51: "Çiseleme", 61: "Yağmurlu", 71: "Kar", 80: "Sağanak"
    };
    return map[code] || "Bilinmiyor";
  }

  function weatherCodeToIcon(code) {
    if ([0].includes(code)) return '<i class="fas fa-sun text-yellow-400"></i>';
    if ([1, 2].includes(code)) return '<i class="fas fa-cloud-sun text-yellow-300"></i>';
    if ([3].includes(code)) return '<i class="fas fa-cloud text-gray-500"></i>';
    if ([45].includes(code)) return '<i class="fas fa-smog text-gray-400"></i>';
    if ([51].includes(code)) return '<i class="fas fa-cloud-rain text-blue-400"></i>';
    if ([61, 80].includes(code)) return '<i class="fas fa-cloud-showers-heavy text-blue-600"></i>';
    if ([71].includes(code)) return '<i class="fas fa-snowflake text-blue-300"></i>';
    return '<i class="fas fa-question text-gray-400"></i>';
  }
</script>
</body>
</html>
